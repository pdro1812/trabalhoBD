<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerenciar Clientes PJ</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Roboto&display=swap" rel="stylesheet">
  <link href="css/lista_clientes.css" rel="stylesheet">
</head>
<body>
  <a href="tela_principal.html" class="back-button">← Voltar</a>
  <img src="scapini-logo.jpg" alt="Restaurante Scapini" class="logo">

  <div class="container">
    <h1>Clientes - Pessoa Jurídica</h1>

    <form id="formPJ">
      <div class="form-group">
        <label for="nome">Nome</label>
        <input type="text" id="nome" required>
      </div>
      <div class="form-group">
        <label for="cnpj">CNPJ</label>
        <input type="text" id="cnpj" required>
      </div>
      <div class="form-group">
        <label for="valorLivre">Valor Livre</label>
        <input type="number" id="valorLivre" required>
      </div>
      <div class="form-group">
        <label for="valorMarmita">Valor da Marmita</label>
        <input type="number" id="valorMarmita" required>
      </div>
      <div class="form-group">
        <label for="valorKilo">Valor por Kilo</label>
        <input type="number" id="valorKilo" required>
      </div>
      <button type="submit">Adicionar Empresa</button>
    </form>

    <div class="search-box">
      <input type="text" id="busca" placeholder="Buscar...">
    </div>

    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>CNPJ</th>
          <th>Valor Livre</th>
          <th>Valor Marmita</th>
          <th>Valor Kilo</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tabelaPJ"></tbody>
    </table>
  </div>

  <script>
    const form = document.getElementById('formPJ');
    const tabela = document.getElementById('tabelaPJ');
    const busca = document.getElementById('busca');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const nome = document.getElementById('nome').value;
      const cnpj = document.getElementById('cnpj').value;
      const valorLivre = document.getElementById('valorLivre').value;
      const valorMarmita = document.getElementById('valorMarmita').value;
      const valorKilo = document.getElementById('valorKilo').value;

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${nome}</td>
        <td>${cnpj}</td>
        <td>${valorLivre}</td>
        <td>${valorMarmita}</td>
        <td>${valorKilo}</td>
        <td>
          <button onclick="editar(this)">Editar</button>
          <button onclick="excluir(this)">Excluir</button>
        </td>
      `;
      tabela.appendChild(row);

      
    await fetch('/clientes/pj', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ nome, cnpj, valorLivre, valorMarmita, valorKilo })
    });

    carregarEmpresas();

      

      form.reset();
    });

    function editar(btn) {
      const row = btn.parentElement.parentElement;
      const cells = row.children;
      document.getElementById('nome').value = cells[0].textContent;
      document.getElementById('cnpj').value = cells[1].textContent;
      document.getElementById('valorLivre').value = cells[2].textContent;
      document.getElementById('valorMarmita').value = cells[3].textContent;
      document.getElementById('valorKilo').value = cells[4].textContent;
      row.remove();
    }

    function excluir(btn) {
      btn.parentElement.parentElement.remove();
    }

    busca.addEventListener('input', () => {
      const termo = busca.value.toLowerCase();
      Array.from(tabela.children).forEach(row => {
        row.style.display = [...row.children].some(td =>
          td.textContent.toLowerCase().includes(termo)
        ) ? '' : 'none';
      });
    });

    async function carregarEmpresas() {
  tabela.innerHTML = '';
  const response = await fetch('/clientes/pj');
  const empresas = await response.json();

  empresas.forEach(emp => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${emp.nome}</td>
      <td>${emp.cnpj}</td>
      <td>${emp.valor_livre}</td>
      <td>${emp.valor_marmita}</td>
      <td>${emp.valor_kg}</td>
      <td>
        <button onclick="editarEmpresa(${emp.id}, this)">Editar</button>
        <button onclick="excluirEmpresa(${emp.id})">Excluir</button>
      </td>
    `;
    tabela.appendChild(row);
  });
}

async function excluirEmpresa(id) {
  await fetch(`/clientes/pj/${id}`, {
    method: 'DELETE'
  });
  carregarEmpresas();
}

  </script>
</body>
</html>
