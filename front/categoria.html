<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciar Categorias</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Roboto&display=swap" rel="stylesheet">
  <link href="css/categoria.css" rel="stylesheet">
</head>
<body>

  <!-- Botão de voltar -->
  <a href="tela_principal.html" class="back-button">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M10 19l-7-7 7-7v4h8v6h-8v4z"/>
    </svg>
    Voltar
  </a>

  <!-- Logo -->
  <img src="scapini-logo.jpg" alt="Restaurante Scapini" class="logo">

  <!-- Container -->
  <div class="container">
    <h1>Gerenciar Categorias</h1>

    <!-- Tabela de categorias -->
    <table>
      <thead>
        <tr>
          <th>Nome da Categoria</th>
          <th class="checkbox-column">Selecionar</th>
        </tr>
      </thead>
      <tbody id="categoryTableBody">
      </tbody>
    </table>

    <!-- Botões -->
    <div class="button-group">
      <button onclick="toggleCategoryForm()">Adicionar Categoria</button>
      <button onclick="editCategory()">Editar Categoria</button>
      <button onclick="removeSelectedCategories()">Remover Selecionadas</button>
    </div>

    <!-- Formulário de categoria -->
    <form id="categoryForm" style="display: none;">
      <div class="form-group">
        <label for="categoryName">Nome da Categoria</label>
        <input type="text" id="categoryName" placeholder="Digite o nome da categoria" required>
      </div>
      <button type="submit">Salvar Categoria</button>
    </form>
  </div>

  <script>
  const categoryForm = document.getElementById('categoryForm');
  const categoryTableBody = document.getElementById('categoryTableBody');
  let editingRow = null;
  let editingId = null;

  async function carregarCategorias() {
    try {
      const res = await fetch('/categorias');
      const categorias = await res.json();

      categoryTableBody.innerHTML = '';

      categorias.forEach(categoria => {
        const row = document.createElement('tr');
        row.setAttribute('id_categoria', categoria.id_categoria);
        row.innerHTML = `
          <td>${categoria.nome}</td>
          <td class="checkbox-column"><input type="checkbox" class="remove-checkbox"></td>
        `;
        categoryTableBody.appendChild(row);
      });
    } catch (err) {
      console.error('Erro ao carregar categorias:', err);
    }
  }

  function toggleCategoryForm() {
    categoryForm.style.display = categoryForm.style.display === 'none' ? 'block' : 'none';
    editingId = null;
    editingRow = null;
    categoryForm.reset();
  }

  categoryForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('categoryName').value;

    if (!name) return alert('Informe o nome da categoria.');

    try {
      if (editingId) {
        const res = await fetch(`/categorias/${editingId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome: name })
        });

        if (!res.ok) throw new Error('Erro ao editar no banco.');

        const updated = await res.json();
        editingRow.cells[0].textContent = updated.nome;
      } else {
        const res = await fetch('/categorias', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome: name })
        });

        if (!res.ok) throw new Error('Erro ao salvar no banco.');

        const novaCategoria = await res.json();
        const row = document.createElement('tr');
        row.setAttribute('id_categoria', novaCategoria.id);
        row.innerHTML = `
          <td>${novaCategoria.nome}</td>
          <td class="checkbox-column"><input type="checkbox" class="remove-checkbox"></td>
        `;
        categoryTableBody.appendChild(row);
      }

      categoryForm.reset();
      categoryForm.style.display = 'none';
      editingRow = null;
      editingId = null;
    } catch (err) {
      alert('Erro ao salvar categoria.');
      console.error(err);
    }
  });

  function editCategory() {
    const checkbox = document.querySelector('.remove-checkbox:checked');
    if (!checkbox) return alert('Selecione uma categoria para editar.');

    editingRow = checkbox.closest('tr');
    editingId = editingRow.getAttribute('id_categoria');
    document.getElementById('categoryName').value = editingRow.cells[0].textContent;
    categoryForm.style.display = 'block';
  }

  async function removeSelectedCategories() {
    const checkboxes = document.querySelectorAll('.remove-checkbox:checked');

    for (const checkbox of checkboxes) {
      const row = checkbox.closest('tr');
      const id = row.getAttribute('id_categoria');

      try {
        const res = await fetch(`/categorias/${id}`, { method: 'DELETE' });
        if (res.ok) row.remove();
        else console.error(`Erro ao remover categoria ${id}`);
      } catch (err) {
        console.error(`Erro ao remover categoria ${id}:`, err);
      }
    }
  }

  // Carrega ao abrir
  window.onload = carregarCategorias;
</script>

</body>
</html>
